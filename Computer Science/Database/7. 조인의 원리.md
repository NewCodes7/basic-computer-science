# 조인의 원리

## 중첩 루프 조인 (NLJ, Nested Loop Join)

<img width="550" alt="image" src="https://github.com/BCS-study/basic-computer-science/assets/123712285/42b459a9-b6a3-4d05-8c06-1ed6ec3a2067">

- 의미: 중첩 for 문과 같은 원리로 조건에 맞는 조인을 하는 방법
    - 랜덤 접근에 대한 비용이 많이 증가하므로 대용량의 테이블에서는 사용하지 않는다.
- 블록 중첩 루프 조인(BNL, Block Nested Loop)
    - 중첩 루프 조인에서 발전한 형태이다.
    - 조인할 테이블을 작은 블록으로 나눠서 블록 하나씩으로 조인한다.

## 정렬 병합 조인


<img width="550" alt="image" src="https://github.com/BCS-study/basic-computer-science/assets/123712285/410fcf2e-7ed2-4bc6-86c3-92e237469293">

- 의미: 각각의 테이블을 조인할 필드 기준으로 정렬하고, 정렬이 끝난 이후에 조인 작업을 수행하는 조인
- 주 사용처: 조인할 때 쓸 적절한 인덱스가 없고, 대용량의 테이블들을 조인하고, 조인 조건으로 <,> 등 범위 비교 연산자가 있을 때

## 해시 조인

<img width="600" alt="image" src="https://github.com/BCS-study/basic-computer-science/assets/123712285/28dd34a2-9972-4fb4-9f7f-77c2958b7df3">

- 의미: 해시 테이블을 기반으로 조인하는 방법
- 특징
    - 두 개의 테이블을 조인한다고 했을 때, 하나의 테이블이 메모리에 온전히 들어간다면 보통 중첩 루프 조인보다 더 효율적이다.
    - 메모리에 올릴 수 없을 정도로 크다면 디스크를 사용하는 비용이 발생된다.
    - 동등(=) 조인에서만 사용할 수 있다.
    - MySQL8.0.18 릴리스와 함께 이 기능을 사용할 수 있게 되었다.

### MySQL에서의 해시 조인 단계

- 빌드 단계
    - 의미: 입력 테이블 중 하나를 기반으로 메모리 내 해시 테이블을 빌드하는 단계
- 프로브 단계
    - 의미: 레코드 읽기를 시작하며 각 레코드에서 해시 테이블의 키와 일치하는 레코드를 찾아서 결괏값으로 반환하는 단계
    - 각 테이블은 한 번씩만 읽게 되어 중첩 루프 조인보다 보통 성능이 더 뛰어나다.
    - 참고: 사용 가능한 메모리양은 시스템 변수 join_buffer_size에 의해 제어되며, 런타임 시에 조정할 수 있다.

## 레퍼런스

- 이미지 출처
    - 동작 원리 gif: https://bertwagner.com/posts/visualizing-nested-loops-joins-and-understanding-their-implications/