# 트랜잭션과 무결성

## 핵심 용어

- `트랜잭션` : 데이터베이스에서 하나의 논리적 기능을 수행하기 위한 작업의 단위
- `무결성` : 데이터의 **정확성, 일관성, 유효성**을 유지하는 것

## 트랜잭션

<img width="500" alt="image" src="https://github.com/BCS-study/basic-computer-science/assets/123712285/9eb77306-e959-4b3a-927e-855561c1135d
">

- 의미: 데이터베이스에서 하나의 논리적 기능을 수행하기 위한 작업의 단위
    - 여러 개의 쿼리들을 하나로 묶는 단위
- 특징 (ACID)

| ACID 요소 | 설명 |
| --- | --- |
| 원자성 (Atomicity) | 트랜잭션 내의 모든 작업은 전부 성공하거나 전부 실패해야 합니다. 어떠한 작업도 중간에 중단되어서는 안 됩니다. |
| 일관성 (Consistency) | 트랜잭션이 실행 전과 후에 데이터베이스가 일관된 상태를 유지해야 합니다. 트랜잭션이 일어나더라도 데이터베이스의 제약 조건, 규칙 등이 항상 유지되어야 합니다. |
| 고립성 (Isolation) | 여러 트랜잭션이 동시에 실행되더라도, 각 트랜잭션은 서로 영향을 주지 않고 독립적으로 실행되는 것처럼 보여야 합니다. |
| 지속성 (Durability) | 트랜잭션이 성공적으로 완료되면, 해당 변경 사항은 영구적으로 저장되어야 합니다. 시스템 장애가 발생하더라도 데이터 손실이 없어야 합니다. |

### 원자성(atomicity)

- 의미: “all or nothing”
    - 트랜잭셩과 관련된 일이 모두 수행되었거나 되지 않았거나를 보장하는 특징
- 예시
    - 트랜잭션을 커밋했는데, 문제가 발생하여 롤백하는 경우 그 이후에 모두 수행되지 않음을 보장하는 것
- 주의 사항
    - 트랜잭션 단위로 여러 로직들을 묶을 때 외부 API를 호출하면 안 됩니다. 만약 있다면 롤백 일어났을 때 어떻게 해야 할 것인지에 대한 해결 방법 있어야 하고 트랜잭션 전파를 신경 써서 관리해야 합니다.
- 커밋과 롤백
    
    <img width="500" alt="image" src="https://github.com/BCS-study/basic-computer-science/assets/123712285/127ee9e2-e00e-48f9-843f-dc63a288efc1
">
    
    - 커밋: 여러 쿼리가 성공적으로 처리되었다고 확정하는 명령어
        - 트랜잭션 단위로 수행되며 변경된 내용이 모두 영구적으로 저장되는 것을 말합니다.
        - “커밋이 수행되었다.” = “하나의 트랜잭션이 성공적으로 수행되었다.”
    - 롤백: 트랜잭션으로 처리한 하나의 묶음 과정을 일어나기 전으로 돌리는 일(취소)
    - 이러한 커밋과 롤백 덕분에 **데이터의 무결성**이 보장됩니다. 또한, 데이터 변경 전에 변경 사항을 쉽게 확인할 수 있고 해당 작업을 **그룹화**할 수 있습니다.
- 트랜잭션 전파
    - 의미: 여러 트랜잭션 관련 메서드의 호출을 하나의 트랜잭션에 묶이도록 하는 것
    - 예시: Spring 프레임워크에서의 @Transactional

### 일관성(consistency)

- 의미: ‘허용된 방식’으로만 데이터를 변경해야 하는 것
    - 허용된 방식: 데이터베이스에 기록된 모든 데이터는 **여러 제약 조건, 규칙**에 따라 유효함을 가져야 합니다.
- 예시: 잔고에 0원이 있는 상태에서 500만 원을 송금하는 것은 불가능합니다. 이는 허용된 방식이 아니기 때문입니다.

### 격리성(isolation)

- 의미: 트랜잭션 수행 시 서로 끼어들지 못하는 것
    - 복수의 정렬 트랜잭션은 서로 격리되어 마치 순차적으로 실행되는 것처럼 작동되어야 합니다. 데이터베이스는 여러 사용자가 같은 데이터에 접근할 수 있도록 해야 합니다.
- 격리성을 보장하는 여러 개의 격리 수준
    
    <img width="500" alt="image" src="https://github.com/BCS-study/basic-computer-science/assets/123712285/f6bba35e-f5d2-478d-8cdf-8cbcf0b2ebb5
">
    
    1. READ_UNCOMMITED
        - 각 트랜잭션에서의 변경 내용이 COMMIT이나 ROLLBACK 여부에 상관 없이 다른 트랜잭션에서 값을 읽을 수 있습니다.
        - 정합성에 문제가 많은 격리 수준이기 때문에 사용하지 않는 것을 권장합니다.
        - DIRTY READ가 발생합니다.
    2. READ_COMMITED
        - 커밋이 된 데이터만 읽습니다.
        - RDB에서 대부분 기본적으로 사용되고 있는 격리 수준입니다.
        - Dirty Read와 같은 현상은 발생하지 않지만, NON-REPEATABLE READ가 발생합니다.
    3. REPEATABLE_READ
        - 자신의 트랜잭션이 생성되기 이전의 트랜잭션에서 COMMIT이 된 데이터만 읽습니다.
        - MySQL과 MariaDB가 기본으로 사용하는 격리 수준입니다.
        - MySQL에서는 트랜잭션마다 트랜잭션 ID를 부여하여 트랜잭션 ID보다 작은 트랜잭션 번호에서 변경한 것만 읽게 됩니다.
        - PHANTOM READ가 발생합니다.
    4. SERIALIZABLE 
        - 가장 단순한 격리 수준이지만 가장 엄격한 격리 수준입니다.
        - 데이터를 접근할 때, 항상 Lock을 걸고 데이터를 조회합니다.
        - SERIALIZABLE에서는 PHANTOM READ가 발생하지 않습니다.
        - 성능 문제로 데이터베이스에서 거의 사용되지 않습니다.
- 트랜잭션에서 일어날 수 있는 문제들

| 문제 | 설명 |
| --- | --- |
| Dirty Read (더티 리드) | 다른 트랜잭션이 아직 커밋되지 않은 다른 트랜잭션의 변경 사항을 읽을 때 발생합니다. 이로 인해 롤백된 트랜잭션에 의해 변경된 데이터를 읽게 되어 일관성이 깨질 수 있습니다. |
| Non-repeatable Read (비반복 가능한 리드) | 동일한 쿼리를 두 번 실행할 때, 두 번째 읽기에서 첫 번째와 다른 결과가 반환되는 경우입니다. 이는 다른 트랜잭션이 중간에 데이터를 변경하여 발생할 수 있습니다. |
| Phantom Read (유령 리드) | 동일한 쿼리를 두 번 실행할 때, 두 번째 실행에서는 새로운 행이나 이전에 없던 행이 결과에 포함될 수 있습니다. 이 역시 다른 트랜잭션이 데이터를 삽입, 삭제 또는 갱신하여 발생할 수 있습니다. |

### 지속성(durability)

- 의미: 성공적으로 수행된 트랜잭션은 영원히 반영되어야 하는 것
    - 이는 데이터베이스에 시스템 장애가 발생해도 원래 상태로 복구하는 회복 기능이 있어야 함을 뜻합니다.
- 지속성을 위한 기능
    - 체크섬: 중복 검사의 한 형태로, 오류 정정을 통해 송신된 자료의 무결성을 보호하는 단순한 방법
    - 저널링: 파일 시스템 또는 데이터베이스 시스템에 변경 사항을 반영(commit)하기 전에 로깅하는 것, 트랜잭션 등 변경 사항에 대한 로그를 남기는 것
    - 롤백: 트랜잭션으로 처리한 하나의 묶음 과정을 일어나기 전으로 돌리는 일(취소)

## 무결성 (**Integrity**)

- 의미: 데이터의 **정확성, 일관성, 유효성**을 유지하는 것
    - 무결성이 유지되어야 데이터베이스에 저장된 데이터 값과 값에 해당하는 현실 세계의 값이 일치하는지에 대한 신뢰가 생깁니다.
- 무결성 종류
    - 개체 무결성(Entity Integrity): 기본키로 선택된 필드는 빈 값을 허용하지 않습니다.
    - 참조 무결성(Referential Integrity): 서로 참조 관계에 있는 두 테이블의 데이터는 항상 일관된 값을 유지해야 합니다.
    - 고유 무결성(Unique integrity): 특정 속성에 대해 고유한 값을 가지도록 조건이 주어진 경우, 그 속성 값은 모두 고유한 값을 가집니다.
    - NULL 무결성(Null integrity): 특정 속성 값에 NULL이 올 수 없다는 조건이 주어진 경우, 그 속성 값은 NULL이 될 수 없다는 제약 조건입니다.

---

## 레퍼런스

- 이미지 출처
    - 트랜잭션: https://velog.io/@junhyeok/Transaction-ACID
    - 커밋: [https://itwiki.kr/w/트랜잭션](https://itwiki.kr/w/%ED%8A%B8%EB%9E%9C%EC%9E%AD%EC%85%98)
- 본문 출처
    - 면접을 위한 CS전공지식 노트(주홍철)
    - 트랜잭션 격리 수준: [https://velog.io/@yujiniii/데이터베이스-트랜잭션-격리-수준](https://velog.io/@yujiniii/%EB%8D%B0%EC%9D%B4%ED%84%B0%EB%B2%A0%EC%9D%B4%EC%8A%A4-%ED%8A%B8%EB%9E%9C%EC%9E%AD%EC%85%98-%EA%B2%A9%EB%A6%AC-%EC%88%98%EC%A4%80)